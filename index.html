<html>
<head>
  <title>Hexagram</title>
  <link href="/images/favicon.ico" rel="icon" type="image/x-icon" />
  <link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/2.1.2/normalize.css" />
  <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="css/index.css" rel="stylesheet">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="/js/getTags.js"></script>
  <script src="/jscolor/jscolor-min.js"></script>
</head>
<body>
  <div class="container">
    <div class="hashtag-form">
      <h3>Enter a hashtag to search for images</h3>
      <form action="/" method="GET" class="hashtagSelection" onsubmit="handleSubmit(); return false;">
        <input type="text" id="hashtag" name="hashtag" placeholder="#" autocomplete="off" autofocus /><br>
      </form>
    </div>
    <div class="hashtag-container" id="hashtag-container"></div>
    <div class="superuser" id="superuser">
      <div class="gear" id="gear">
        <i class="icon-cog cog"></i>
      </div>
      <div class="settings" id="settings">
        <p class="picker">Rows:<select name="hex-rows" id="rows">
          <option value="4">4</option>
          <option value="5" selected="selected">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select></p>
        <p class="picker">Padding:<select name="hex-padding" id="pad">
          <option value="0">0</option>
          <option value="5">5</option>
          <option value="10" selected="selected">10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="25">25</option>
          <option value="30">30</option>
        </select></p>
        <p class="picker">Color one: <input class="color {pickerClosable:true}" id="bg1" value="#000000"></p>
        <p class="picker">Color two: <input class="color {pickerClosable:true}" id="bg2" value="#333333"></p>
      </div>
    </div>
  </div>
  <script>

    (function() {
      
      var tag;
      var timeout;
      var $hashtag = $('#hashtag');
      var $tagContainer = $('#hashtag-container');
      var $gear = $('#gear');
      var $superuser = $('#superuser');
      var $settings = $('#settings');

      var getTags = function(hash, callback) {
        $.ajax({
          url: '/api/tags/' + hash,
          success: function(response){
            console.log(response);
            callback.call(self, response.tags);
          },
          error: function(error) {
            console.log(error);
          }
        });
      };

      var renderTags = function(tags) {
        if ($hashtag.val()) {
          $tagContainer.empty();
          tags.forEach(function(tag) {
            var $p = $('<p class="tag">');
            var $link = $('<a>').attr({'href': '/'+tag.name}).text('#' + tag.name);
            $link.appendTo($p);
            $p.appendTo($tagContainer);
          });
        }
      }

      var handleSubmit = function(evt) {

        if (evt) {
          evt.preventDefault();
        }

        var hashtag = $hashtag.val();
        hashtag = hashtag.slice(1);
        var url = '' + hashtag;
        var rows = $('#rows').val();
        var pad = $('#pad').val();
        var bg1 = $('#bg1').val();
        var bg2 = $('#bg2').val();

        url += '?rows='+rows+'&pad='+pad+'&bg1='+bg1+'&bg2='+bg2;

        window.location = url;
      }

      var wait200 = function(fn, arg1, arg2) {
        timeout = window.setTimeout(fn, 200, arg1, arg2);
      };

      $hashtag.on('keyup', function() {
        var text = $hashtag.val();
        if (text.length && text.charAt(0) !== '#') {
          $hashtag.val('#'.concat(text));
        }
        if (text.length > 2) {
          window.clearTimeout(timeout);
          text = text.slice(1);
          wait200(getTags, text, renderTags);
        } else if (!text.length) {
          $tagContainer.empty();
          window.clearTimeout(timeout);
        }
      });

      $gear.on('click', function() {
        $superuser.toggleClass('show');
        $gear.toggleClass('dark');
        $settings.toggleClass('dark');
      });

      $tagContainer.on('click', 'a', handleSubmit);
    }())

  </script>
</body>
</html>
